name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: pip install ruff
      - run: ruff check backend/ --config pyproject.toml
      - run: ruff format --check backend/ --config pyproject.toml

  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: backend-lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-ml.txt
          pip install ruff aiosqlite
      - name: Run tests
        env:
          PYTHONPATH: backend
          DATABASE_URL: sqlite+aiosqlite:///test.db
        run: python -m pytest backend/tests/ -v --tb=short

  enterprise-seed-validation:
    name: Enterprise Seed Validation
    runs-on: ubuntu-latest
    needs: backend-lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
      - name: Generate smoke enterprise seed
        run: |
          python backend/scripts/seed_enterprise_data.py \
            --days 7 \
            --products 100 \
            --stores 5 \
            --output data/seed_ci
      - name: Validate seeded enterprise artifacts
        run: |
          python backend/scripts/validate_enterprise_seed.py \
            --input data/seed_ci \
            --strict

  edi-fixture-e2e:
    name: EDI Fixture E2E
    runs-on: ubuntu-latest
    needs: backend-lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-ml.txt
          pip install aiosqlite
      - name: Run deterministic EDI fixture harness
        env:
          PYTHONPATH: backend
          DATABASE_URL: sqlite+aiosqlite:///test.db
        run: python -m pytest backend/tests/test_edi_adapter.py -v --tb=short

  contract-validation-suite:
    name: Contract Validation Suite
    runs-on: ubuntu-latest
    needs: backend-lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-ml.txt
          pip install aiosqlite
      - name: Run contract and mapping tests
        env:
          PYTHONPATH: backend
          DATABASE_URL: sqlite+aiosqlite:///test.db
        run: |
          python -m pytest backend/tests/test_contract_profiles.py backend/tests/test_contract_mapper.py backend/tests/test_validate_customer_contract.py backend/tests/test_run_onboarding_flow.py -v --tb=short
      - name: Validate demo SMB contract against fixture
        env:
          PYTHONPATH: backend
        run: |
          python backend/scripts/validate_customer_contract.py \
            --contract contracts/demo_smb/smb_csv/v1.yaml \
            --sample-path backend/tests/fixtures/contracts/sample_smb.csv \
            --output-json backend/reports/contract_validation_ci.json \
            --output-md backend/reports/contract_validation_ci.md

  docs-command-check:
    name: Docs Command Check
    runs-on: ubuntu-latest
    needs: backend-lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install -r backend/requirements-ml.txt
      - name: Validate documented command surfaces
        env:
          PYTHONPATH: backend
        run: |
          python backend/scripts/validate_training_datasets.py --base-dir . --output /tmp/dataset_validation.md
          python backend/scripts/run_training.py --help > /tmp/run_training_help.txt
          python backend/scripts/benchmark_datasets.py --help > /tmp/benchmark_help.txt

  postgres-parity:
    name: Postgres Parity
    runs-on: ubuntu-latest
    needs: backend-lint
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: shelfops
          POSTGRES_USER: shelfops
          POSTGRES_PASSWORD: dev_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U shelfops -d shelfops"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql+asyncpg://shelfops:dev_password@localhost:5432/shelfops
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install alembic
      - name: Run migrations on Postgres
        working-directory: backend
        run: alembic upgrade head
      - name: Validate tenant session settings work on Postgres
        run: |
          python - <<'PY'
          import asyncio
          from sqlalchemy import text
          from sqlalchemy.ext.asyncio import create_async_engine

          async def main():
              engine = create_async_engine("postgresql+asyncpg://shelfops:dev_password@localhost:5432/shelfops")
              async with engine.connect() as conn:
                  await conn.execute(text("SELECT set_config('app.current_customer_id', '00000000-0000-0000-0000-000000000001', false)"))
                  result = await conn.execute(text("SELECT current_setting('app.current_customer_id', TRUE)"))
                  value = result.scalar_one_or_none()
                  assert value == "00000000-0000-0000-0000-000000000001"
              await engine.dispose()

          asyncio.run(main())
          PY

  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
        working-directory: frontend
      - run: npm run lint
        working-directory: frontend

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: frontend-lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
        working-directory: frontend
      - run: npm run build
        working-directory: frontend
